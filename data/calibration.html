<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ - Smart Column S3</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–º—É –∏–∑ localStorage
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.addEventListener('DOMContentLoaded', function() {
                document.body.setAttribute('data-theme', savedTheme);
            });
        })();
    </script>
    <style>
        .calibration-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .cal-section {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cal-section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .sensor-list {
            list-style: none;
            padding: 0;
        }

        .sensor-item {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .sensor-item.invalid {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .sensor-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .sensor-actions {
            display: flex;
            gap: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-ok {
            background: #4CAF50;
            color: white;
        }

        .status-error {
            background: #f44336;
            color: white;
        }

        .info-text {
            color: #666;
            font-size: 13px;
            margin-top: 5px;
        }

        .result-message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            display: none;
        }

        .result-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .result-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .back-link {
            display: inline-block;
            color: #4CAF50;
            text-decoration: none;
            font-size: 0.9em;
            margin-bottom: 20px;
            transition: opacity 0.3s;
        }

        .back-link:hover {
            opacity: 0.7;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        [data-theme="dark"] .back-link {
            color: #66bb6a;
        }

        [data-theme="dark"] .calibration-container {
            color: #e0e0e0;
        }

        [data-theme="dark"] .cal-section {
            background: #1e1e1e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        [data-theme="dark"] .cal-section h2 {
            color: #e0e0e0;
            border-bottom-color: #66bb6a;
        }

        [data-theme="dark"] .cal-section h3 {
            color: #e0e0e0;
        }

        [data-theme="dark"] .form-group label {
            color: #b0b0b0;
        }

        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group select {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .sensor-item {
            background: #2a2a2a;
            border-left-color: #66bb6a;
        }

        [data-theme="dark"] .sensor-item.invalid {
            background: #3a1f1f;
            border-left-color: #f44336;
        }

        [data-theme="dark"] .sensor-info strong {
            color: #e0e0e0;
        }

        [data-theme="dark"] .info-text {
            color: #999;
        }

        [data-theme="dark"] .result-message.success {
            background: #1b5e20;
            color: #a5d6a7;
            border-color: #2e7d32;
        }

        [data-theme="dark"] .result-message.error {
            background: #5d1f1f;
            color: #ef9a9a;
            border-color: #c62828;
        }

        [data-theme="dark"] hr {
            border-color: #444;
        }
    </style>
</head>
<body>
    <div class="calibration-container">
        <h1>‚öôÔ∏è –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h1>
        <a href="index.html" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</a>

        <!-- –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ -->
        <div class="cal-section">
            <h2>üîß –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞</h2>

            <div class="form-group">
                <label>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
                <div class="info-text" id="pumpCurrent">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <h3>–ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞</h3>
            <div class="form-group">
                <label for="mlPerRev">–º–ª –Ω–∞ –æ–±–æ—Ä–æ—Ç:</label>
                <input type="number" id="mlPerRev" step="0.001" min="0" placeholder="0.500">
            </div>
            <button class="btn" onclick="calibratePumpDirect()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>

            <hr style="margin: 20px 0;">

            <h3>–ú–µ—Ç–æ–¥ 2: –ò–∑–º–µ—Ä–µ–Ω–∏–µ</h3>
            <p class="info-text">1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞—Å–æ—Å –Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤<br>
               2. –ò–∑–º–µ—Ä—å—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º –≤ –º–µ—Ä–Ω–æ–π –ø–æ—Å—É–¥–µ<br>
               3. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∂–µ</p>

            <div class="form-group">
                <label for="knownVolume">–ò–∑–º–µ—Ä–µ–Ω–Ω—ã–π –æ–±—ä—ë–º (–º–ª):</label>
                <input type="number" id="knownVolume" step="0.1" min="0" placeholder="100.0">
            </div>
            <div class="form-group">
                <label for="steps">–í—ã–ø–æ–ª–Ω–µ–Ω–æ —à–∞–≥–æ–≤:</label>
                <input type="number" id="steps" min="1" placeholder="3200">
            </div>
            <button class="btn" onclick="calibratePumpMeasured()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å</button>

            <div id="pumpResult" class="result-message"></div>
        </div>

        <!-- –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–æ–≤ -->
        <div class="cal-section">
            <h2>üå°Ô∏è –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–æ–≤</h2>

            <button class="btn btn-secondary" onclick="scanSensors()">üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—á–∏–∫–∏</button>
            <button class="btn btn-secondary" onclick="loadCalibration()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>

            <div style="margin-top: 20px;">
                <ul class="sensor-list" id="sensorList">
                    <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
                </ul>
            </div>

            <div id="tempResult" class="result-message"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/calibration';

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        async function loadCalibration() {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();

                // –ù–∞—Å–æ—Å
                document.getElementById('pumpCurrent').textContent =
                    `${data.pump.mlPerRev.toFixed(3)} –º–ª/–æ–±–æ—Ä–æ—Ç ` +
                    `(${data.pump.stepsPerRev} —à–∞–≥–æ–≤/–æ–± √ó ${data.pump.microsteps} –º–∏–∫—Ä–æ—à–∞–≥–æ–≤)`;
                document.getElementById('mlPerRev').value = data.pump.mlPerRev.toFixed(3);

                // –¢–µ—Ä–º–æ–º–µ—Ç—Ä—ã
                const list = document.getElementById('sensorList');
                list.innerHTML = '';

                const tempNames = ['–ö—É–±', '–¶–∞—Ä–≥–∞ –Ω–∏–∑', '–¶–∞—Ä–≥–∞ –≤–µ—Ä—Ö', '–î–µ—Ñ–ª–µ–≥–º–∞—Ç–æ—Ä', '–¢–°–ê', '–í–æ–¥–∞ –≤—Ö–æ–¥', '–í–æ–¥–∞ –≤—ã—Ö–æ–¥'];

                data.temperatures.forEach((temp, i) => {
                    const li = document.createElement('li');
                    li.className = `sensor-item ${temp.valid ? '' : 'invalid'}`;
                    li.innerHTML = `
                        <div class="sensor-info">
                            <div>
                                <strong>${tempNames[temp.index] || '–î–∞—Ç—á–∏–∫ ' + temp.index}</strong>
                                <span class="status-badge ${temp.valid ? 'status-ok' : 'status-error'}">
                                    ${temp.valid ? '‚úì OK' : '‚úó –û—à–∏–±–∫–∞'}
                                </span>
                                <div class="info-text">–ê–¥—Ä–µ—Å: ${temp.address}</div>
                                <div class="info-text">–¢–µ–∫—É—â–µ–µ: <strong>${temp.current.toFixed(2)}¬∞C</strong>, –°–º–µ—â–µ–Ω–∏–µ: ${temp.offset.toFixed(2)}¬∞C</div>
                            </div>
                        </div>
                        <div class="sensor-actions">
                            <input type="number" id="offset_${i}" value="${temp.offset.toFixed(2)}" step="0.01"
                                   style="width: 100px;" placeholder="–°–º–µ—â–µ–Ω–∏–µ">
                            <button class="btn" onclick="calibrateTempOffset(${i})">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–º–µ—â–µ–Ω–∏–µ</button>
                            <input type="number" id="ref_${i}" step="0.1" style="width: 100px;" placeholder="–≠—Ç–∞–ª–æ–Ω ¬∞C">
                            <button class="btn btn-secondary" onclick="calibrateTempReference(${i})">–ü–æ —ç—Ç–∞–ª–æ–Ω—É</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('Load error:', error);
                showResult('tempResult', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ (–ø—Ä—è–º–∞—è)
        async function calibratePumpDirect() {
            const mlPerRev = parseFloat(document.getElementById('mlPerRev').value);
            if (isNaN(mlPerRev) || mlPerRev <= 0) {
                showResult('pumpResult', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–ª/–æ–±–æ—Ä–æ—Ç', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/pump`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mlPerRev })
                });

                if (response.ok) {
                    showResult('pumpResult', `‚úì –ù–∞—Å–æ—Å –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω: ${mlPerRev.toFixed(3)} –º–ª/–æ–±–æ—Ä–æ—Ç`, 'success');
                    loadCalibration();
                } else {
                    showResult('pumpResult', '–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('pumpResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ (–∏–∑–º–µ—Ä–µ–Ω–∏–µ)
        async function calibratePumpMeasured() {
            const knownVolume = parseFloat(document.getElementById('knownVolume').value);
            const steps = parseInt(document.getElementById('steps').value);

            if (isNaN(knownVolume) || knownVolume <= 0 || isNaN(steps) || steps <= 0) {
                showResult('pumpResult', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/pump`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ knownVolume, steps })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('pumpResult',
                        `‚úì –ù–∞—Å–æ—Å –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω: ${data.mlPerRev.toFixed(3)} –º–ª/–æ–±–æ—Ä–æ—Ç (–∏–∑–º–µ—Ä–µ–Ω–æ ${knownVolume} –º–ª –∑–∞ ${steps} —à–∞–≥–æ–≤)`,
                        'success');
                    loadCalibration();
                } else {
                    showResult('pumpResult', '–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('pumpResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–∞ (—Å–º–µ—â–µ–Ω–∏–µ)
        async function calibrateTempOffset(index) {
            const offset = parseFloat(document.getElementById(`offset_${index}`).value);
            if (isNaN(offset)) {
                showResult('tempResult', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/temp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index, offset })
                });

                if (response.ok) {
                    showResult('tempResult', `‚úì –î–∞—Ç—á–∏–∫ ${index} –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω: —Å–º–µ—â–µ–Ω–∏–µ ${offset.toFixed(2)}¬∞C`, 'success');
                    loadCalibration();
                } else {
                    showResult('tempResult', '–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('tempResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–∞ (—ç—Ç–∞–ª–æ–Ω)
        async function calibrateTempReference(index) {
            const reference = parseFloat(document.getElementById(`ref_${index}`).value);
            if (isNaN(reference)) {
                showResult('tempResult', '–í–≤–µ–¥–∏—Ç–µ —ç—Ç–∞–ª–æ–Ω–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/temp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index, reference })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('tempResult',
                        `‚úì –î–∞—Ç—á–∏–∫ ${index} –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω –ø–æ —ç—Ç–∞–ª–æ–Ω—É ${reference.toFixed(1)}¬∞C, —Å–º–µ—â–µ–Ω–∏–µ: ${data.offset.toFixed(2)}¬∞C`,
                        'success');
                    loadCalibration();
                } else {
                    showResult('tempResult', '–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('tempResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤
        async function scanSensors() {
            try {
                const response = await fetch(`${API_BASE}/scan`);
                const data = await response.json();
                showResult('tempResult', `‚úì –ù–∞–π–¥–µ–Ω–æ –¥–∞—Ç—á–∏–∫–æ–≤: ${data.count}`, 'success');
                loadCalibration();
            } catch (error) {
                showResult('tempResult', '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `result-message ${type}`;
            setTimeout(() => {
                el.className = 'result-message';
            }, 5000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadCalibration();
    </script>
</body>
</html>
