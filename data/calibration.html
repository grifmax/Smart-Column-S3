<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ - Smart Column S3</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–º—É –∏–∑ localStorage
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.addEventListener('DOMContentLoaded', function() {
                document.body.setAttribute('data-theme', savedTheme);
            });
        })();
    </script>
    <style>
        .calibration-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .cal-section {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cal-section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .sensor-list {
            list-style: none;
            padding: 0;
        }

        .sensor-item {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .sensor-item.invalid {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .sensor-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .sensor-actions {
            display: flex;
            gap: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-ok {
            background: #4CAF50;
            color: white;
        }

        .status-error {
            background: #f44336;
            color: white;
        }

        .info-text {
            color: #666;
            font-size: 13px;
            margin-top: 5px;
        }

        .result-message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            display: none;
        }

        .result-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .result-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .back-link {
            display: inline-block;
            color: #4CAF50;
            text-decoration: none;
            font-size: 0.9em;
            margin-bottom: 20px;
            transition: opacity 0.3s;
        }

        .back-link:hover {
            opacity: 0.7;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        [data-theme="dark"] .back-link {
            color: #66bb6a;
        }

        [data-theme="dark"] .calibration-container {
            color: #e0e0e0;
        }

        [data-theme="dark"] .cal-section {
            background: #1e1e1e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        [data-theme="dark"] .cal-section h2 {
            color: #e0e0e0;
            border-bottom-color: #66bb6a;
        }

        [data-theme="dark"] .cal-section h3 {
            color: #e0e0e0;
        }

        [data-theme="dark"] .form-group label {
            color: #b0b0b0;
        }

        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group select {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .sensor-item {
            background: #2a2a2a;
            border-left-color: #66bb6a;
        }

        [data-theme="dark"] .sensor-item.invalid {
            background: #3a1f1f;
            border-left-color: #f44336;
        }

        [data-theme="dark"] .sensor-info strong {
            color: #e0e0e0;
        }

        [data-theme="dark"] .info-text {
            color: #999;
        }

        [data-theme="dark"] .result-message.success {
            background: #1b5e20;
            color: #a5d6a7;
            border-color: #2e7d32;
        }

        [data-theme="dark"] .result-message.error {
            background: #5d1f1f;
            color: #ef9a9a;
            border-color: #c62828;
        }

        [data-theme="dark"] hr {
            border-color: #444;
        }

        [data-theme="dark"] .info-text[style*="background: #fff3cd"] {
            background: #3a3a1f !important;
            color: #ffd54f !important;
            border-left-color: #ffc107 !important;
        }

        [data-theme="dark"] #cal-progress-container {
            background: #1f2a3a !important;
            border-left-color: #2196F3 !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] #cal-progress-container strong {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] details summary {
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="calibration-container">
        <h1>‚öôÔ∏è –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h1>
        <a href="index.html" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</a>

        <!-- –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ -->
        <div class="cal-section">
            <h2>üîß –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞</h2>

            <div class="form-group">
                <label>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
                <div class="info-text" id="pumpCurrent">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <p class="info-text" style="background: #fff3cd; padding: 10px; border-radius: 4px; border-left: 4px solid #ffc107;">
                ‚ö†Ô∏è <strong>–í–∞–∂–Ω–æ:</strong> –¢–æ—á–Ω–æ—Å—Ç—å –Ω–∞–ª–∏–≤–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ª–∏–Ω–µ–π–Ω–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–∫–æ—Ä–æ—Å—Ç—è—Ö.
                –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–Ω–∏–º—É–º 2 –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏: –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ <strong>200 –º–ª/—á–∞—Å</strong> –∏ <strong>1500 –º–ª/—á–∞—Å</strong>.
            </p>

            <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label for="cal-speed">–°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–ª–∏–≤–∞ (–º–ª/—á–∞—Å)</label>
                    <select id="cal-speed" onchange="updateCalibrationTime()">
                        <option value="150">150 –º–ª/—á–∞—Å</option>
                        <option value="200" selected>200 –º–ª/—á–∞—Å ‚≠ê —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</option>
                        <option value="300">300 –º–ª/—á–∞—Å</option>
                        <option value="750">750 –º–ª/—á–∞—Å</option>
                        <option value="1000">1000 –º–ª/—á–∞—Å</option>
                        <option value="1500">1500 –º–ª/—á–∞—Å ‚≠ê —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</option>
                        <option value="2000">2000 –º–ª/—á–∞—Å</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cal-volume">–û–±—ä—ë–º —Ç–∞—Ä—ã (–º–ª)</label>
                    <select id="cal-volume" onchange="updateCalibrationTime()">
                        <option value="50">50 –º–ª</option>
                        <option value="100" selected>100 –º–ª</option>
                        <option value="250">250 –º–ª</option>
                        <option value="500">500 –º–ª</option>
                        <option value="1000">1000 –º–ª</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>–†–∞—Å—á—ë—Ç–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞–ª–∏–≤–∞:</label>
                <div class="info-text" id="cal-time" style="font-size: 1.1em; font-weight: 600;">30 –º–∏–Ω</div>
            </div>

            <div id="cal-progress-container" style="display: none; margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 6px; border-left: 4px solid #2196F3;">
                <div style="margin-bottom: 10px;">
                    <strong>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...</strong>
                </div>
                <div style="background: #ddd; height: 30px; border-radius: 15px; overflow: hidden; margin-bottom: 10px;">
                    <div id="cal-progress-bar" style="background: linear-gradient(90deg, #4CAF50, #66bb6a); height: 100%; width: 0%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;"></div>
                </div>
                <div class="info-text">
                    –ü—Ä–æ—à–ª–æ: <span id="cal-elapsed">0 –º–∏–Ω 0 —Å–µ–∫</span> / <span id="cal-total">0 –º–∏–Ω</span>
                </div>
            </div>

            <div id="cal-manual-volume" style="display: none; margin: 20px 0;">
                <div class="form-group">
                    <label for="actual-volume">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ª–∏—Ç—ã–π –æ–±—ä—ë–º (–º–ª):</label>
                    <input type="number" id="actual-volume" step="0.1" min="0" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–±—ä—ë–º">
                    <p class="info-text">–ï—Å–ª–∏ –≤—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –¥–æ—Å—Ä–æ—á–Ω–æ, –≤–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –Ω–∞–ª–∏—Ç.</p>
                </div>
            </div>

            <div class="controls" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" id="btn-start-cal" onclick="startCalibration()">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏</button>
                <button class="btn" id="btn-stop-cal" onclick="stopCalibration()" style="display: none; background: #ff9800;">‚èπÔ∏è –°—Ç–æ–ø</button>
                <button class="btn btn-secondary" id="btn-apply-cal" onclick="applyCalibration()" style="display: none;">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
                <button class="btn" id="btn-cancel-cal" onclick="cancelCalibration()" style="display: none; background: #f44336;">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>

            <div id="pumpResult" class="result-message"></div>

            <hr style="margin: 30px 0;">

            <details>
                <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">–ü—Ä—è–º–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ (–¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)</summary>
                <div class="form-group">
                    <label for="mlPerRev">–º–ª –Ω–∞ –æ–±–æ—Ä–æ—Ç:</label>
                    <input type="number" id="mlPerRev" step="0.001" min="0" placeholder="0.500">
                </div>
                <button class="btn" onclick="calibratePumpDirect()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </details>
        </div>

        <!-- –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–æ–≤ -->
        <div class="cal-section">
            <h2>üå°Ô∏è –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–æ–≤</h2>

            <button class="btn btn-secondary" onclick="scanSensors()">üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—á–∏–∫–∏</button>
            <button class="btn btn-secondary" onclick="loadCalibration()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>

            <div style="margin-top: 20px;">
                <ul class="sensor-list" id="sensorList">
                    <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
                </ul>
            </div>

            <div id="tempResult" class="result-message"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/calibration';

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        async function loadCalibration() {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();

                // –ù–∞—Å–æ—Å
                document.getElementById('pumpCurrent').textContent =
                    `${data.pump.mlPerRev.toFixed(3)} –º–ª/–æ–±–æ—Ä–æ—Ç ` +
                    `(${data.pump.stepsPerRev} —à–∞–≥–æ–≤/–æ–± √ó ${data.pump.microsteps} –º–∏–∫—Ä–æ—à–∞–≥–æ–≤)`;
                document.getElementById('mlPerRev').value = data.pump.mlPerRev.toFixed(3);

                // –¢–µ—Ä–º–æ–º–µ—Ç—Ä—ã
                const list = document.getElementById('sensorList');
                list.innerHTML = '';

                const tempNames = ['–ö—É–±', '–¶–∞—Ä–≥–∞ –Ω–∏–∑', '–¶–∞—Ä–≥–∞ –≤–µ—Ä—Ö', '–î–µ—Ñ–ª–µ–≥–º–∞—Ç–æ—Ä', '–¢–°–ê', '–í–æ–¥–∞ –≤—Ö–æ–¥', '–í–æ–¥–∞ –≤—ã—Ö–æ–¥'];

                data.temperatures.forEach((temp, i) => {
                    const li = document.createElement('li');
                    li.className = `sensor-item ${temp.valid ? '' : 'invalid'}`;
                    li.innerHTML = `
                        <div class="sensor-info">
                            <div>
                                <strong>${tempNames[temp.index] || '–î–∞—Ç—á–∏–∫ ' + temp.index}</strong>
                                <span class="status-badge ${temp.valid ? 'status-ok' : 'status-error'}">
                                    ${temp.valid ? '‚úì OK' : '‚úó –û—à–∏–±–∫–∞'}
                                </span>
                                <div class="info-text">–ê–¥—Ä–µ—Å: ${temp.address}</div>
                                <div class="info-text">–¢–µ–∫—É—â–µ–µ: <strong>${temp.current.toFixed(2)}¬∞C</strong>, –°–º–µ—â–µ–Ω–∏–µ: ${temp.offset.toFixed(2)}¬∞C</div>
                            </div>
                        </div>
                        <div class="sensor-actions">
                            <input type="number" id="offset_${i}" value="${temp.offset.toFixed(2)}" step="0.01"
                                   style="width: 100px;" placeholder="–°–º–µ—â–µ–Ω–∏–µ">
                            <button class="btn" onclick="calibrateTempOffset(${i})">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–º–µ—â–µ–Ω–∏–µ</button>
                            <input type="number" id="ref_${i}" step="0.1" style="width: 100px;" placeholder="–≠—Ç–∞–ª–æ–Ω ¬∞C">
                            <button class="btn btn-secondary" onclick="calibrateTempReference(${i})">–ü–æ —ç—Ç–∞–ª–æ–Ω—É</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('Load error:', error);
                showResult('tempResult', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ (–ø—Ä—è–º–∞—è)
        async function calibratePumpDirect() {
            const mlPerRev = parseFloat(document.getElementById('mlPerRev').value);
            if (isNaN(mlPerRev) || mlPerRev <= 0) {
                showResult('pumpResult', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–ª/–æ–±–æ—Ä–æ—Ç', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/pump`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mlPerRev })
                });

                if (response.ok) {
                    showResult('pumpResult', `‚úì –ù–∞—Å–æ—Å –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω: ${mlPerRev.toFixed(3)} –º–ª/–æ–±–æ—Ä–æ—Ç`, 'success');
                    loadCalibration();
                } else {
                    showResult('pumpResult', '–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('pumpResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ (–∏–∑–º–µ—Ä–µ–Ω–∏–µ)
        async function calibratePumpMeasured() {
            const knownVolume = parseFloat(document.getElementById('knownVolume').value);
            const steps = parseInt(document.getElementById('steps').value);

            if (isNaN(knownVolume) || knownVolume <= 0 || isNaN(steps) || steps <= 0) {
                showResult('pumpResult', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/pump`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ knownVolume, steps })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('pumpResult',
                        `‚úì –ù–∞—Å–æ—Å –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω: ${data.mlPerRev.toFixed(3)} –º–ª/–æ–±–æ—Ä–æ—Ç (–∏–∑–º–µ—Ä–µ–Ω–æ ${knownVolume} –º–ª –∑–∞ ${steps} —à–∞–≥–æ–≤)`,
                        'success');
                    loadCalibration();
                } else {
                    showResult('pumpResult', '–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('pumpResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–∞ (—Å–º–µ—â–µ–Ω–∏–µ)
        async function calibrateTempOffset(index) {
            const offset = parseFloat(document.getElementById(`offset_${index}`).value);
            if (isNaN(offset)) {
                showResult('tempResult', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/temp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index, offset })
                });

                if (response.ok) {
                    showResult('tempResult', `‚úì –î–∞—Ç—á–∏–∫ ${index} –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω: —Å–º–µ—â–µ–Ω–∏–µ ${offset.toFixed(2)}¬∞C`, 'success');
                    loadCalibration();
                } else {
                    showResult('tempResult', '–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('tempResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–∞ (—ç—Ç–∞–ª–æ–Ω)
        async function calibrateTempReference(index) {
            const reference = parseFloat(document.getElementById(`ref_${index}`).value);
            if (isNaN(reference)) {
                showResult('tempResult', '–í–≤–µ–¥–∏—Ç–µ —ç—Ç–∞–ª–æ–Ω–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/temp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index, reference })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('tempResult',
                        `‚úì –î–∞—Ç—á–∏–∫ ${index} –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω –ø–æ —ç—Ç–∞–ª–æ–Ω—É ${reference.toFixed(1)}¬∞C, —Å–º–µ—â–µ–Ω–∏–µ: ${data.offset.toFixed(2)}¬∞C`,
                        'success');
                    loadCalibration();
                } else {
                    showResult('tempResult', '–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('tempResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤
        async function scanSensors() {
            try {
                const response = await fetch(`${API_BASE}/scan`);
                const data = await response.json();
                showResult('tempResult', `‚úì –ù–∞–π–¥–µ–Ω–æ –¥–∞—Ç—á–∏–∫–æ–≤: ${data.count}`, 'success');
                loadCalibration();
            } catch (error) {
                showResult('tempResult', '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `result-message ${type}`;
            setTimeout(() => {
                el.className = 'result-message';
            }, 5000);
        }

        // ============================================================================
        // –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –Ω–∞—Å–æ—Å–∞
        // ============================================================================

        let calibrationState = {
            running: false,
            startTime: null,
            targetTime: 0,
            targetVolume: 0,
            speed: 0,
            interval: null
        };

        // –û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—á—ë—Ç–Ω–æ–µ –≤—Ä–µ–º—è
        function updateCalibrationTime() {
            const speed = parseInt(document.getElementById('cal-speed').value);
            const volume = parseInt(document.getElementById('cal-volume').value);
            const timeMinutes = (volume / speed) * 60;

            document.getElementById('cal-time').textContent =
                timeMinutes >= 1
                    ? `${Math.floor(timeMinutes)} –º–∏–Ω ${Math.round((timeMinutes % 1) * 60)} —Å–µ–∫`
                    : `${Math.round(timeMinutes * 60)} —Å–µ–∫`;
        }

        // –ó–∞–ø—É—Å–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        async function startCalibration() {
            const speed = parseInt(document.getElementById('cal-speed').value);
            const volume = parseInt(document.getElementById('cal-volume').value);

            calibrationState = {
                running: true,
                startTime: Date.now(),
                targetTime: (volume / speed) * 3600000, // –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
                targetVolume: volume,
                speed: speed,
                interval: null
            };

            // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç
            document.getElementById('btn-start-cal').style.display = 'none';
            document.getElementById('btn-stop-cal').style.display = 'inline-block';
            document.getElementById('btn-cancel-cal').style.display = 'inline-block';
            document.getElementById('cal-progress-container').style.display = 'block';
            document.getElementById('cal-total').textContent =
                `${Math.floor(calibrationState.targetTime / 60000)} –º–∏–Ω`;

            // –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å–æ—Å —á–µ—Ä–µ–∑ API
            try {
                const response = await fetch('/api/pump/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ speed: speed })
                });

                if (!response.ok) {
                    throw new Error('Failed to start pump');
                }

                showResult('pumpResult', `‚úì –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞: ${volume} –º–ª –ø—Ä–∏ ${speed} –º–ª/—á–∞—Å`, 'success');

                // –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                calibrationState.interval = setInterval(updateCalibrationProgress, 1000);

            } catch (error) {
                showResult('pumpResult', '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –Ω–∞—Å–æ—Å–∞', 'error');
                cancelCalibration();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateCalibrationProgress() {
            if (!calibrationState.running) return;

            const elapsed = Date.now() - calibrationState.startTime;
            const progress = Math.min((elapsed / calibrationState.targetTime) * 100, 100);

            document.getElementById('cal-progress-bar').style.width = progress + '%';
            document.getElementById('cal-progress-bar').textContent = Math.round(progress) + '%';

            const elapsedSec = Math.floor(elapsed / 1000);
            const minutes = Math.floor(elapsedSec / 60);
            const seconds = elapsedSec % 60;
            document.getElementById('cal-elapsed').textContent = `${minutes} –º–∏–Ω ${seconds} —Å–µ–∫`;

            // –ê–≤—Ç–æ–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (elapsed >= calibrationState.targetTime) {
                stopCalibration(true);
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        async function stopCalibration(autoStop = false) {
            if (!calibrationState.running) return;

            calibrationState.running = false;
            clearInterval(calibrationState.interval);

            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å–æ—Å —á–µ—Ä–µ–∑ API
            try {
                await fetch('/api/pump/stop', { method: 'POST' });
            } catch (error) {
                console.error('Error stopping pump:', error);
            }

            // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å—Ç–æ–ø, –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å/–æ—Ç–º–µ–Ω–∞
            document.getElementById('btn-stop-cal').style.display = 'none';
            document.getElementById('btn-apply-cal').style.display = 'inline-block';

            // –ï—Å–ª–∏ –¥–æ—Å—Ä–æ—á–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞, –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –æ–±—ä—ë–º–∞
            if (!autoStop) {
                document.getElementById('cal-manual-volume').style.display = 'block';
                showResult('pumpResult', '–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–±—ä—ë–º –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç"', 'info');
            } else {
                document.getElementById('actual-volume').value = calibrationState.targetVolume;
                showResult('pumpResult', '–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
            }
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        async function applyCalibration() {
            let actualVolume = parseFloat(document.getElementById('actual-volume').value);

            if (isNaN(actualVolume) || actualVolume <= 0) {
                showResult('pumpResult', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–±—ä—ë–º', 'error');
                return;
            }

            const elapsed = Date.now() - calibrationState.startTime;
            const elapsedHours = elapsed / 3600000;
            const actualSpeed = actualVolume / elapsedHours;

            // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–ª/–æ–±–æ—Ä–æ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            // –≠—Ç–æ —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç, —Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            try {
                const response = await fetch(`${API_BASE}/pump`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        knownVolume: actualVolume,
                        elapsedMs: elapsed,
                        targetSpeed: calibrationState.speed
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('pumpResult',
                        `‚úì –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞! –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${data.mlPerRev?.toFixed(3) || '–æ–±–Ω–æ–≤–ª–µ–Ω–æ'} –º–ª/–æ–±–æ—Ä–æ—Ç`,
                        'success');
                    loadCalibration();
                    resetCalibrationUI();
                } else {
                    showResult('pumpResult', '–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏', 'error');
                }
            } catch (error) {
                showResult('pumpResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –û—Ç–º–µ–Ω–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        async function cancelCalibration() {
            if (calibrationState.running) {
                clearInterval(calibrationState.interval);
                try {
                    await fetch('/api/pump/stop', { method: 'POST' });
                } catch (error) {
                    console.error('Error stopping pump:', error);
                }
            }

            resetCalibrationUI();
            showResult('pumpResult', '–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', 'info');
        }

        // –°–±—Ä–æ—Å UI
        function resetCalibrationUI() {
            calibrationState = { running: false, startTime: null, targetTime: 0, targetVolume: 0, speed: 0, interval: null };

            document.getElementById('btn-start-cal').style.display = 'inline-block';
            document.getElementById('btn-stop-cal').style.display = 'none';
            document.getElementById('btn-apply-cal').style.display = 'none';
            document.getElementById('btn-cancel-cal').style.display = 'none';
            document.getElementById('cal-progress-container').style.display = 'none';
            document.getElementById('cal-manual-volume').style.display = 'none';
            document.getElementById('cal-progress-bar').style.width = '0%';
            document.getElementById('actual-volume').value = '';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadCalibration();
        updateCalibrationTime();
    </script>
</body>
</html>
