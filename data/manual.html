<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - Smart Column S3</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .manual-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .control-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .slider-container {
            margin: 15px 0;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--primary-color);
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .slider:hover {
            opacity: 1;
        }
        .value-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 600;
        }
        .temp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .temp-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 15px;
            border-radius: 8px;
            color: white;
            text-align: center;
        }
        .temp-value {
            font-size: 28px;
            font-weight: bold;
            margin: 5px 0;
        }
        .temp-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .valve-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .valve-btn {
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--primary-color);
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        .valve-btn.active {
            background: var(--primary-color);
            color: white;
        }
        .status-bar {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }
        .status-dot.running {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <h1>üéõÔ∏è –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
            <a href="index.html" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="process-status"></div>
                <span id="status-text">–ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
            </div>
            <div>
                <button class="btn btn-success" id="btn-start" onclick="startManualProcess()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                <button class="btn btn-danger" id="btn-stop" onclick="stopProcess()" style="display:none;">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="manual-grid">
            <!-- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã -->
            <div class="control-panel">
                <h2>üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</h2>
                <div class="temp-grid">
                    <div class="temp-card">
                        <div class="temp-label">–ö—É–±</div>
                        <div class="temp-value" id="temp-cube">--</div>
                        <div class="temp-label">¬∞C</div>
                    </div>
                    <div class="temp-card">
                        <div class="temp-label">–ö–æ–ª–æ–Ω–Ω–∞</div>
                        <div class="temp-value" id="temp-column">--</div>
                        <div class="temp-label">¬∞C</div>
                    </div>
                    <div class="temp-card">
                        <div class="temp-label">–î–µ—Ñ–ª–µ–≥–º–∞—Ç–æ—Ä</div>
                        <div class="temp-value" id="temp-defleg">--</div>
                        <div class="temp-label">¬∞C</div>
                    </div>
                    <div class="temp-card">
                        <div class="temp-label">–ü—Ä–æ–¥—É–∫—Ç</div>
                        <div class="temp-value" id="temp-product">--</div>
                        <div class="temp-label">¬∞C</div>
                    </div>
                </div>
            </div>

            <!-- –ù–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å -->
            <div class="control-panel">
                <h2>üî• –ù–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å</h2>
                <div class="slider-container">
                    <div class="value-display">
                        <span>–ú–æ—â–Ω–æ—Å—Ç—å:</span>
                        <span id="heater-display">0%</span>
                    </div>
                    <input type="range" min="0" max="100" value="0" class="slider" id="heater-slider"
                           oninput="updateHeaterManual(this.value)">
                </div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 14px;">
                        <span>–¢–µ–∫—É—â–∞—è: <strong id="heater-current">0 –í—Ç</strong></span>
                        <span>–ú–∞–∫—Å: <strong>3000 –í—Ç</strong></span>
                    </div>
                </div>
            </div>

            <!-- –ù–∞—Å–æ—Å -->
            <div class="control-panel">
                <h2>üíß –ù–∞—Å–æ—Å –æ—Ç–±–æ—Ä–∞</h2>
                <div class="slider-container">
                    <div class="value-display">
                        <span>–°–∫–æ—Ä–æ—Å—Ç—å:</span>
                        <span id="pump-display">0 –º–ª/—á</span>
                    </div>
                    <input type="range" min="0" max="300" value="0" class="slider" id="pump-slider"
                           oninput="updatePumpManual(this.value)">
                </div>
                <div style="margin-top: 15px;">
                    <div style="font-size: 14px;">
                        –û—Ç–æ–±—Ä–∞–Ω–æ: <strong id="collected-volume">0 –º–ª</strong>
                    </div>
                </div>
            </div>

            <!-- –ö–ª–∞–ø–∞–Ω—ã -->
            <div class="control-panel">
                <h2>üîÄ –ö–ª–∞–ø–∞–Ω—ã</h2>
                <div class="valve-grid">
                    <button class="valve-btn" id="valve-heads" onclick="toggleValveManual('heads')">
                        ü•É –ì–æ–ª–æ–≤—ã
                    </button>
                    <button class="valve-btn" id="valve-body" onclick="toggleValveManual('body')">
                        üç∑ –¢–µ–ª–æ
                    </button>
                    <button class="valve-btn" id="valve-tails" onclick="toggleValveManual('tails')">
                        üß™ –•–≤–æ—Å—Ç—ã
                    </button>
                    <button class="valve-btn" id="valve-waste" onclick="toggleValveManual('waste')">
                        ‚ôªÔ∏è –û—Ç—Ö–æ–¥—ã
                    </button>
                </div>
            </div>
        </div>

        <!-- –õ–æ–≥ -->
        <div class="control-panel" style="margin-top: 20px;">
            <h2>üìã –ñ—É—Ä–Ω–∞–ª</h2>
            <div id="log-container" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            </div>
        </div>
    </div>

    <script>
        let processRunning = false;
        let updateInterval = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            loadStatus();
            startUpdates();
            addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞
        async function startManualProcess() {
            try {
                const response = await fetch('/api/process/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'manual_rect' })
                });

                if (response.ok) {
                    processRunning = true;
                    updateUI();
                    addLog('‚úÖ –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º –∑–∞–ø—É—â–µ–Ω', 'success');
                } else {
                    const error = await response.text();
                    addLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + error, 'error');
                }
            } catch (e) {
                addLog('‚ùå –û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
        async function stopProcess() {
            if (!confirm('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å?')) return;

            try {
                const response = await fetch('/api/process/stop', {
                    method: 'POST'
                });

                if (response.ok) {
                    processRunning = false;
                    updateUI();
                    addLog('‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'warning');
                } else {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏', 'error');
                }
            } catch (e) {
                addLog('‚ùå –û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è
        function updateHeaterManual(value) {
            document.getElementById('heater-display').textContent = value + '%';
            // TODO: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            addLog(`üî• –ú–æ—â–Ω–æ—Å—Ç—å –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è: ${value}%`);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞—Å–æ—Å–∞
        function updatePumpManual(value) {
            document.getElementById('pump-display').textContent = value + ' –º–ª/—á';
            // TODO: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            addLog(`üíß –°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞—Å–æ—Å–∞: ${value} –º–ª/—á`);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∞–ø–∞–Ω–∞
        function toggleValveManual(valve) {
            const btn = document.getElementById('valve-' + valve);
            const isActive = btn.classList.contains('active');

            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–ª–∞–ø–∞–Ω—ã
            document.querySelectorAll('.valve-btn').forEach(b => b.classList.remove('active'));

            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π
            if (!isActive) {
                btn.classList.add('active');
                addLog(`üîÄ –ö–ª–∞–ø–∞–Ω "${valve}" –æ—Ç–∫—Ä—ã—Ç`);
            } else {
                addLog(`üîÄ –í—Å–µ –∫–ª–∞–ø–∞–Ω—ã –∑–∞–∫—Ä—ã—Ç—ã`);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            const statusDot = document.getElementById('process-status');
            const statusText = document.getElementById('status-text');
            const btnStart = document.getElementById('btn-start');
            const btnStop = document.getElementById('btn-stop');

            if (processRunning) {
                statusDot.classList.add('running');
                statusText.textContent = '–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)';
                btnStart.style.display = 'none';
                btnStop.style.display = 'inline-block';
            } else {
                statusDot.classList.remove('running');
                statusText.textContent = '–ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                btnStart.style.display = 'inline-block';
                btnStop.style.display = 'none';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
                document.getElementById('temp-cube').textContent = data.temps?.cube?.toFixed(1) || '--';
                document.getElementById('temp-column').textContent = data.temps?.column?.toFixed(1) || '--';
                document.getElementById('temp-defleg').textContent = data.temps?.defleg?.toFixed(1) || '--';
                document.getElementById('temp-product').textContent = data.temps?.product?.toFixed(1) || '--';

                // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
                processRunning = data.mode !== 'idle';
                updateUI();

            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', e);
            }
        }

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        function startUpdates() {
            updateInterval = setInterval(loadStatus, 2000);
        }

        // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥
        function addLog(message, level = 'info') {
            const container = document.getElementById('log-container');
            const time = new Date().toLocaleTimeString();
            const colors = {
                info: '#2196F3',
                success: '#4CAF50',
                warning: '#FF9800',
                error: '#F44336'
            };
            const color = colors[level] || colors.info;

            const entry = document.createElement('div');
            entry.style.color = color;
            entry.textContent = `[${time}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;

            // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }
    </script>
</body>
</html>
