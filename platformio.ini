; Smart-Column S3 - Контроллер ректификационной колонны
; Платформа: ESP32-S3 DevKitC-1 N16R8
; Версия: 1.4.9

[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; Исключить только старый код из компиляции
; Модули control/, drivers/, interface/, storage/ нужны для main.cpp
build_src_filter = +<*> -<old/>

; Память - явно указываем для N16R8
board_build.partitions = partitions.csv
board_upload.flash_size = 16MB
board_build.flash_mode = qio
board_build.f_flash = 80000000L

; PSRAM конфигурация для N16R8
board_build.arduino.memory_type = qio_opi

; Библиотеки
lib_deps =
    paulstoffregen/OneWire@^2.3.8
    milesburton/DallasTemperature@^3.11.0
    adafruit/Adafruit BMP280 Library@^2.6.8
    adafruit/Adafruit ADS1X15@^2.5.0
    adafruit/Adafruit GFX Library@^1.11.5
    adafruit/Adafruit SSD1306@^2.5.7
    mandulaj/PZEM-004T-v30@^1.1.2
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git
    bblanchon/ArduinoJson@^7.0.4
    witnessmenow/UniversalTelegramBot@^1.3.0
    bodmer/TFT_eSPI@^2.5.43
    waspinator/AccelStepper@^1.64
    madhephaestus/ESP32Servo@^1.1.2
    knolleary/PubSubClient@^2.8

; Исключить конфликтующие библиотеки
lib_ignore = WebServer

; Режим поиска зависимостей
lib_ldf_mode = chain+

; Флаги сборки
build_flags =
    -Iinclude
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM  ; Плата N16R8 имеет 8 МБ PSRAM
    -DUSE_LITTLEFS     ; Используем LittleFS вместо SPIFFS
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; TFT_eSPI настройки (ILI9488 3.5")
    -DUSER_SETUP_LOADED=1
    -DILI9488_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    -DTFT_MISO=-1
    -DTFT_MOSI=35
    -DTFT_SCLK=36
    -DTFT_CS=37
    -DTFT_DC=39
    -DTFT_RST=40
    -DSPI_FREQUENCY=40000000

; Мониторинг
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Загрузка
upload_speed = 115200

; LittleFS (более надежная, чем SPIFFS)
board_build.filesystem = littlefs

; Скрипт для генерации версии фронтенда
extra_scripts = pre:scripts/generate_version.py
; Исключить незавершённые модули из сборки (конфликт архитектуры v2)
; Эти модули используют include/types.h который несовместим с src/config.h

[env:esp32s3_ota]
extends = env:esp32s3
upload_protocol = espota
upload_port = smart-column.local
