# Smart-Column S3 — Спецификация

**Версия:** 1.2
**Дата:** 2025-12-06
**Платформа:** ESP32-S3 DevKitC-1 N16R8
**Бюджет:** ~11,250₽  

---

## 1. Обзор проекта

Smart-Column S3 — универсальный контроллер автоматизации ректификационной колонны с поддержкой нескольких режимов работы, веб-интерфейсом, Telegram-ботом и расширенной системой безопасности.

### Ключевые возможности

- 5 режимов работы: авто-ректификация, ручная ректификация, дистилляция, затирка солода, Hold
- Watt-Control — автоподбор мощности по давлению
- Smart Decrement — адаптивное снижение скорости отбора
- Электронный ареометр на базе дифференциального датчика давления
- Web UI с анимированной схемой оборудования
- Telegram-бот с уведомлениями и удалённым управлением
- MQTT интеграция с Home Assistant (MQTT Discovery)
- HTTP Basic Auth и Rate Limiting для защиты веб-интерфейса
- OTA-обновления прошивки
- Логирование на SPIFFS с экспортом в CSV

---

## 2. Оборудование (BOM)

### 2.1 Контроллер и питание

| Компонент | Модель | Цена |
|-----------|--------|------|
| Микроконтроллер | ESP32-S3 DevKitC-1 N16R8 | 1000₽ |
| Блок питания | DR-60-12 (12V 5A DIN) | 800₽ |
| DC-DC преобразователь | LM2596 → 5.1V | 100₽ |
| **Итого питание** | | **1900₽** |

### 2.2 Датчики

| Компонент | Модель | Кол-во | Цена |
|-----------|--------|--------|------|
| Датчик давления | MPX5010DP (0-10 кПа) | 1 | 600₽ |
| АЦП 16-бит | ADS1115 | 1 | 250₽ |
| Атм. давление | BMP280 | 2 | 200₽ |
| Термометры | DS18B20 водонепр. | 7 | 1000₽ |
| AC вольтметр | ZMPT101B | 1 | 250₽ |
| AC амперметр | ACS712-30A | 1 | 150₽ |
| Датчик потока воды | YF-S201 | 1 | 150₽ |
| Датчик уровня | Оптический (опция) | 1 | 200₽ |
| **Итого датчики** | | | **2800₽** |

### 2.3 Силовая часть

| Компонент | Модель | Цена |
|-----------|--------|------|
| Твердотельное реле | SSR-40DA + радиатор | 500₽ |
| Оптрон развязки | PC817 | 50₽ |
| Разъёмы | GX12 ×6 | 480₽ |
| **Итого силовая** | | **1030₽** |

### 2.4 Исполнительные механизмы

| Компонент | Модель | Кол-во | Цена |
|-----------|--------|--------|------|
| Шаговый двигатель | NEMA 17 | 1 | 900₽ |
| Драйвер шаговика | TMC2209 | 1 | 400₽ |
| Электроклапан 12V NC | ∅8мм | 3 | 1350₽ |
| MOSFET модули | IRF520/IRF3205 | 3 | 300₽ |
| **Итого исполнители** | | | **2950₽** |

### 2.5 Опциональные компоненты

| Компонент | Модель | Цена |
|-----------|--------|------|
| Сервопривод фракционник | MG996R (5 позиций) | 350₽ |
| Клапан старт-стоп | 12V NC + MOSFET | 550₽ |
| **Итого опции** | | **900₽** |

### 2.6 Интерфейс и корпус

| Компонент | Модель | Цена |
|-----------|--------|------|
| Дисплей основной | 3.5" TFT ILI9488 | 800₽ |
| Дисплей резерв | OLED 0.96" I2C | 150₽ |
| Зуммер | Активный 5V | 50₽ |
| Кнопки | Тактовые ×4 | 50₽ |
| Корпус | Пластиковый бокс 12-18 модулей | 800₽ |
| Мелочёвка | Провода, клеммы, стойки | 500₽ |
| **Итого интерфейс** | | **2350₽** |

### **ИТОГО BOM: ~11,930₽** (с опциями)

---

## 3. Распиновка ESP32-S3

### 3.1 Шины данных

| Интерфейс | GPIO | Устройства |
|-----------|------|------------|
| I2C SDA | GPIO21 | BMP280 ×2, ADS1115 |
| I2C SCL | GPIO22 | BMP280 ×2, ADS1115 |
| OneWire | GPIO4 | DS18B20 ×7 (подтяжка 4.7кОм) |

### 3.2 Управление нагревом

| Функция | GPIO | Примечание |
|---------|------|------------|
| SSR нагрев | GPIO5 | Через PC817 оптрон |
| ZMPT101B (напряжение) | GPIO1 | Аналоговый вход |
| ACS712 (ток) | GPIO2 | Аналоговый вход |

### 3.3 Перистальтический насос

| Функция | GPIO |
|---------|------|
| STEP | GPIO6 |
| DIR | GPIO7 |
| EN | GPIO15 |

### 3.4 Клапаны

| Клапан | GPIO |
|--------|------|
| Охлаждение (вода) | GPIO16 |
| Головы | GPIO17 |
| УНО (непрерывный отбор) | GPIO18 |

### 3.5 Опциональные выходы

| Функция | GPIO | Примечание |
|---------|------|------------|
| Сервопривод фракционник | GPIO8 | PWM 50Hz |
| Клапан старт-стоп | GPIO9 | ШИМ управление |

### 3.6 Интерфейс пользователя

| Функция | GPIO |
|---------|------|
| Зуммер | GPIO38 |
| Кнопка (Boot) | GPIO0 |
| Кнопки доп. | GPIO10, GPIO11, GPIO12 |

### 3.7 Датчики (аналоговые через ADS1115)

| Канал ADS1115 | Датчик |
|---------------|--------|
| A0 | MPX5010DP (давление куба) |
| A1 | Резерв |
| A2 | Резерв |
| A3 | Резерв |

### 3.8 Ограничения

> ⚠️ GPIO 33-37 не использовать — заняты внутренней памятью N16R8

---

## 4. Назначение термометров DS18B20

| # | Позиция | Переменная | Применение |
|---|---------|------------|------------|
| 1 | Куб | T_cube | Контроль кипения, окончание погона |
| 2 | Царга низ | T_column_bottom | Базовая температура стабилизации |
| 3 | Царга верх | T_column_top | Smart Decrement, переход фракций |
| 4 | Дефлегматор | T_reflux | Контроль флегмы |
| 5 | ТСА (выход) | T_tsa | Аварийный — прорыв паров |
| 6 | Вода вход | T_water_in | Информационный |
| 7 | Вода выход | T_water_out | Аварийный — перегрев воды |

---

## 5. Режимы работы

### 5.1 Авто-ректификация (FSM)

Полностью автоматический режим с конечным автоматом состояний.

#### Фазы работы

```
IDLE → HEATING → STABILIZATION → HEADS → PURGE → BODY → TAILS → FINISH → IDLE
```

| Фаза | Условие входа | Действия | Условие выхода |
|------|---------------|----------|----------------|
| HEATING | Старт | ТЭН 100%, вода вкл при T_cube>45°C | T_column стабильна |
| STABILIZATION | T стабильна | Работа "на себя" 20 мин | ΔT<0.1°C за 5 мин |
| HEADS | Стабилизация ok | Отбор 5-12% от АС, 50 мл/час/кВт | Объём достигнут ИЛИ T_column↑>0.1°C |
| PURGE | Головы завершены | Пауза 10 мин, клапан закрыт | Таймер |
| BODY | Продувка ok | Smart Decrement, УНО-цикл | Скорость<min ИЛИ T_column↑>0.3°C |
| TAILS | Тело завершено | Максимальный отбор | T_cube ≥ 99°C |
| FINISH | Хвосты завершены | Стоп всё, охлаждение +5 мин | Таймер |

#### Watt-Control (управление мощностью по давлению)

```
P_захлёб = высота_царги_м × коэфф_насадки

Пороги:
  P_рабочее      = P_захлёб × 0.75
  P_предупреждение = P_захлёб × 0.90
  P_аварийный    = P_захлёб × 1.05

Коэффициенты насадки (мм рт.ст./м):
  СПН 3.5 = 15 (по умолчанию)
  СПН 4.0 = 12
  РПН     = 8
```

#### Smart Decrement (адаптивное снижение скорости)

```python
if T_column > T_base + 0.15°C:
    pump.stop()
    wait_until(T_column < T_base + 0.10°C, timeout=5min)
    speed = speed * 0.85
    if speed < 50 ml/hour/kW:
        transition_to(TAILS)
    pump.start()
```

#### УНО-цикл (периодический сброс давления)

```
Параметры (настраиваемые):
  uno_on  = 3 сек   (клапан открыт)
  uno_off = 60 сек  (клапан закрыт)
```

### 5.2 Ручная ректификация

Все параметры настраиваются вручную через Web UI во время погона:
- Мощность ТЭНа
- Скорость отбора
- Переключение фракций кнопкой "Следующая фракция"
- Автоматика поддерживает безопасность и стабилизацию

### 5.3 Дистилляция

Упрощённый режим:
- Только нагрев с контролем мощности
- Термометры: куб, выход
- Электронный ареометр (попугай)
- Без насоса и клапанов переключения

### 5.4 Затирка солода

Перенос из Distiller Control v1.4.0:

| Профиль | Паузы | Время |
|---------|-------|-------|
| Классический | 7 пауз | 110 мин |
| Полный | 7 пауз | 170 мин |
| Быстрый | 4 паузы | 70 мин |

Особенности:
- Центробежный насос (не перистальтика)
- Клапаны не используются
- UI: куб с мешалкой, один датчик T

### 5.5 Hold (температурные ступени)

Универсальный режим поддержания температуры:

```
Пример: 63°C × 30 мин → 72°C × 15 сек → охлаждение
```

Применение:
- Пастеризация пива
- Sous-vide
- Подогрев воды

---

## 6. Опциональные модули

### 6.1 Сервопривод-фракционник (до 5 позиций)

```
Позиции (настраиваемые углы):
  0°   — Головы
  36°  — Подголовники (опционально)
  72°  — Тело
  108° — Предхвостье (опционально)
  144° — Хвосты

Программная настройка:
  positions_enabled[] = {true, false, true, false, true}
  // Пример: только головы → тело → хвосты (3 позиции)
  
  Неактивные позиции пропускаются при автопереключении
  В ручном режиме доступны все 5 позиций

Управление:
  - Плавный поворот
  - Пауза 2 сек после смены позиции
  - Переключение: автоматически по FSM или вручную
```

**3D модели для печати:**
- Pinch Valve: https://www.printables.com/model/247744
- Servo Valve: https://www.printables.com/model/207051
- 3-in-1 Valve: https://www.instructables.com/3d-Printing-Servo-Controlled-and-Other-Valves/

### 6.2 Клапан старт-стоп (ШИМ)

```python
# Логика работы
if T_column <= T_base + 0.15°C:
    valve.open()      # Отбор идёт
else:
    valve.close()     # Работа "на себя"
    
if valve.closed_time > 5min:
    transition_to(TAILS)

# ШИМ управление скоростью
valve.pwm_duty = map(speed, 0, max_speed, 0, 255)
```

### 6.3 Комбинации режимов отбора

| Отбор | Переключение | Описание |
|-------|--------------|----------|
| Насос перистальтика | Y-клапан | Базовая конфигурация |
| Насос | Серво 5 позиций | Точный отбор + 5 ёмкостей |
| Клапан старт-стоп | Y-клапан | Классика самотёк |
| Клапан ШИМ | Серво | Самотёк + 5 ёмкостей |

---

## 7. Система безопасности

### 7.1 Аварийные условия

| Условие | Порог | Действие |
|---------|-------|----------|
| Прорыв паров | T_tsa > 55°C | СТОП всё |
| Перегрев воды | T_water_out > 70°C | СТОП нагрев |
| Нет потока воды | Датчик = 0 при работе | СТОП нагрев |
| Захлёб колонны | P > P_аварийный | СТОП, пауза 30с, рестарт -15% |
| Переполнение ёмкости | Датчик уровня = 1 | СТОП насос |
| Сбой датчика T | Нет ответа > 5 сек | СТОП всё |
| Низкое напряжение | U < 190V | Предупреждение |
| Высокое напряжение | U > 250V | СТОП нагрев |

### 7.2 Приоритеты аварий

```
1. CRITICAL: Прорыв паров, сбой датчика → полная остановка
2. HIGH: Перегрев воды, нет потока → стоп нагрева
3. MEDIUM: Захлёб → авторестарт со снижением мощности
4. LOW: Напряжение → уведомление
```

---

## 8. Калибровка

### 8.1 Термометры DS18B20

```
Процедура:
1. Лёд 0°C → записать offset каждого датчика
2. Кипяток 100°C (с учётом атм. давления) → проверка линейности

Хранение: NVS, массив float[7]
```

### 8.2 Электронный ареометр

```
Калибровка по 3+ точкам:
1. Вода (0%) → P₀
2. Раствор ~40% → P₁ (измерить обычным ареометром)
3. Раствор ~80% → P₂ (измерить обычным ареометром)

Расчёт: полиномиальная интерполяция или lookup table
Формула: ABV = f(ΔP, T, P_atm)
```

### 8.3 Перистальтический насос

```
Процедура:
1. Залить 100 мл воды
2. Прокачать, считая обороты
3. Записать: мл/оборот

Точность: ±2%
```

### 8.4 Датчики мощности (ZMPT101B + ACS712)

```
Калибровка напряжения:
1. Подключить мультиметр параллельно
2. Измерить реальное U при нагрузке
3. Подобрать k_voltage для совпадения

Калибровка тока:
1. Подключить токовые клещи
2. Измерить реальный I при нагрузке
3. Подобрать k_current для совпадения

Точность: ±2-3%
```

### 8.5 Давление захлёба

```
Процедура:
1. Запустить нагрев на максимум
2. Дождаться захлёба (визуально/аудио)
3. Зафиксировать P_max
4. P_захлёб = P_max × 0.95

Автоматически: система запоминает максимальное давление
```

---

## 9. Интерфейсы

### 9.1 Физические органы управления

#### Кнопки (4 шт.)

| Кнопка | Короткое | Длинное (2 сек) |
|--------|----------|-----------------|
| 1 | Старт/Пауза | Стоп |
| 2 | Следующая фракция | Меню режимов |
| 3 | Скорость + | Мощность + |
| 4 | Скорость − | Мощность − |

#### Зуммер

| Событие | Сигнал |
|---------|--------|
| Смена фазы | 2 коротких |
| Предупреждение | 3 коротких |
| Авария | Непрерывный |
| Завершение | Мелодия |

### 9.2 Web UI

#### Технологии
- SVG + CSS анимации + Canvas
- Переключаемая тема (light/dark)
- Адаптивный дизайн

#### Схемы оборудования (4 варианта)

1. **Ректификационная колонна** — дефлегматор, царга, попугай
2. **Аламбик с сухопарником** — классическая дистилляция
3. **Затирка** — куб с мешалкой
4. **Пастеризация** — упрощённая схема

#### Анимации

- Кипение в кубе (пузырьки)
- Поток в змеевике/охладителе
- Капли отбора
- Пульсация при нагреве
- Заполнение ёмкости

#### Вкладки (6 шт.)

| Вкладка | Содержимое |
|---------|------------|
| Главная | Статус, схема, основные параметры |
| Режимы | Выбор и настройка режима |
| Настройки | Параметры оборудования |
| Калибровка | Датчики, насос, ареометр |
| Графики | История параметров в реальном времени |
| Система | WiFi, Telegram, OTA, экспорт |

### 9.3 Telegram-бот

#### Команды

| Команда | Описание |
|---------|----------|
| /status | Текущее состояние |
| /start_rect | Запуск авто-ректификации |
| /start_dist | Запуск дистилляции |
| /stop | Остановка |
| /pause | Пауза |
| /resume | Продолжить |
| /photo | Скриншот UI |
| /log | Последние записи лога |
| /settings | Текущие настройки |

#### Уведомления

- Смена фазы (с указанием новой)
- Авария (с описанием и рекомендацией)
- Переполнение ёмкости
- Завершение погона (статистика)
- Низкая скорость отбора

### 9.4 MQTT интеграция

#### Home Assistant Discovery

Автоматическое обнаружение устройства в Home Assistant через MQTT Discovery protocol.

**Топики состояния:**
```
smartcolumn/{device_id}/state     - Полное состояние системы (JSON)
smartcolumn/{device_id}/health    - Здоровье системы (0-100%)
smartcolumn/{device_id}/status    - Статус подключения (online/offline)
```

**Discovery топики:**
```
homeassistant/sensor/{device_id}_cube_temp/config
homeassistant/sensor/{device_id}_column_top/config
homeassistant/sensor/{device_id}_voltage/config
homeassistant/sensor/{device_id}_power/config
homeassistant/sensor/{device_id}_energy/config
homeassistant/sensor/{device_id}_health/config
```

#### Сущности в Home Assistant

| Сущность | Класс устройства | Единица | Обновление |
|----------|------------------|---------|------------|
| Температура куба | temperature | °C | 10 сек |
| Температура царги верх | temperature | °C | 10 сек |
| Напряжение | voltage | V | 10 сек |
| Мощность | power | W | 10 сек |
| Энергия | energy | kWh | 10 сек |
| Здоровье системы | None | % | 5 сек |

#### Интеграция с Energy Dashboard

Сенсор энергии использует `state_class: total_increasing` для корректной работы с Energy Dashboard Home Assistant, позволяя отслеживать потребление электроэнергии по дням/месяцам.

#### LWT (Last Will and Testament)

```
Топик: smartcolumn/{device_id}/status
Payload: online / offline
Retain: true
```

При отключении контроллера статус автоматически меняется на `offline`, что отображается в HA как `unavailable`.

### 9.5 Безопасность

#### HTTP Basic Authentication

```
Заголовок: Authorization: Basic <base64(username:password)>
```

**Функции:**
- Защита всех эндпоинтов веб-интерфейса и API
- Настраиваемые username/password через Web UI
- Возможность отключения для локальной сети

#### Rate Limiting

**Параметры:**
- Максимум 60 запросов в минуту с одного IP
- Автоматическая блокировка на 1 минуту при превышении
- Циркулярный буфер на 20 IP-адресов

**HTTP коды:**
- `401 Unauthorized` - неверные credentials
- `429 Too Many Requests` - превышен лимит запросов

#### Security Headers

```
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
```

---

## 10. API Endpoints

### 10.1 Статус (GET)

| Endpoint | Описание |
|----------|----------|
| /api/status | Полный статус системы |
| /api/sensors | Показания всех датчиков |
| /api/log | Последние N записей лога |

### 10.2 Управление (POST)

| Endpoint | Параметры | Описание |
|----------|-----------|----------|
| /api/mode/start | mode, params | Запуск режима |
| /api/mode/stop | — | Остановка |
| /api/mode/pause | — | Пауза |
| /api/mode/next | — | Следующая фракция |
| /api/pump/speed | speed (0-100) | Скорость насоса |
| /api/heater/power | power (0-100) | Мощность ТЭНа |

### 10.3 Настройки (GET/POST)

| Endpoint | Описание |
|----------|----------|
| /api/settings | Все настройки |
| /api/calibration | Данные калибровки |

### 10.4 Система (GET/POST)

| Endpoint | Метод | Описание |
|----------|-------|----------|
| /api/system/info | GET | Версия, uptime, память |
| /api/system/reboot | POST | Перезагрузка |
| /api/system/reset | POST | Сброс настроек |
| /api/export | GET | Экспорт лога в CSV |

---

## 11. Хранение данных

### 11.1 NVS (настройки)

#### Общие
```
wifi_ssid, wifi_pass
telegram_token, telegram_chat_id
mqtt_server, mqtt_port, mqtt_username, mqtt_password
mqtt_base_topic, mqtt_enabled, mqtt_discovery
mqtt_publish_interval
web_username, web_password
auth_enabled, rate_limit_enabled
language (RU/EN)
theme (light/dark)
sound_enabled
```

#### Оборудование
```
column_height_mm
packing_type (SPN35/SPN40/RPN)
packing_coeff (мм рт.ст./м)
heater_power_w
cube_volume_l
```

#### Калибровка
```
ds18b20_offsets[7]
hydrometer_points[3+]
pump_ml_per_rev
p_flood_calibrated
```

#### Режимы (дефолты)
```
rect_heads_percent (5-12, default 8)
rect_body_speed
rect_thresholds
mash_profiles[3]
hold_steps[]
fraction_positions[5] = {0, 36, 72, 108, 144}  // углы
fraction_enabled[5] = {1, 0, 1, 0, 1}          // вкл/выкл
```

### 11.2 SPIFFS (логирование)

#### Интервалы записи

| Параметр | Интервал |
|----------|----------|
| Температуры ×7 | 5 сек |
| Давление куба | 5 сек |
| Давление атм. | 60 сек |
| Крепость ареометр | 10 сек |
| Мощность | 5 сек |
| Скорость отбора | 10 сек |
| Объём (накопительно по фракциям) | 10 сек |
| Состояние FSM | При смене |
| События (аварии, переходы) | При возникновении |

#### Формат файла

```
/logs/YYYYMMDD_HHMMSS.csv

timestamp,t_cube,t_col_bot,t_col_top,t_reflux,t_tsa,t_water_in,t_water_out,p_cube,p_atm,abv,power,speed,volume,state,event
```

---

## 12. Структура проекта

```
smart-column-s3/
├── src/
│   ├── main.cpp
│   ├── config.h              # Пины, константы
│   ├── drivers/
│   │   ├── sensors.cpp       # DS18B20, BMP280, ADS1115
│   │   ├── heater.cpp        # SSR PWM
│   │   ├── pump.cpp          # TMC2209 stepper
│   │   ├── valves.cpp        # Клапаны, серво
│   │   └── display.cpp       # TFT/OLED
│   ├── modes/
│   │   ├── fsm.cpp           # Конечный автомат
│   │   ├── rectification.cpp
│   │   ├── distillation.cpp
│   │   ├── mashing.cpp
│   │   └── hold.cpp
│   ├── control/
│   │   ├── watt_control.cpp  # Управление мощностью
│   │   ├── smart_decrement.cpp
│   │   ├── safety.cpp        # Аварийная защита
│   │   └── pid.cpp           # PID-регулятор
│   ├── interface/
│   │   ├── webserver.cpp     # AsyncWebServer
│   │   ├── api.cpp           # REST API
│   │   ├── telegram.cpp      # Telegram-бот
│   │   ├── mqtt.cpp          # MQTT клиент + HA Discovery
│   │   ├── security.cpp      # Auth + Rate Limiting
│   │   └── buttons.cpp       # Физические кнопки
│   ├── storage/
│   │   ├── nvs_manager.cpp   # Настройки
│   │   └── logger.cpp        # SPIFFS логи
│   └── utils/
│       ├── hydrometer.cpp    # Расчёт крепости
│       └── calibration.cpp
├── data/                     # SPIFFS (Web UI)
│   ├── index.html
│   ├── app.js
│   ├── style.css
│   └── schemes/              # SVG схемы
├── platformio.ini
└── SPEC.md
```

---

## 13. Зависимости (platformio.ini)

```ini
[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

lib_deps =
    paulstoffregen/OneWire
    milesburton/DallasTemperature
    adafruit/Adafruit BMP280 Library
    adafruit/Adafruit ADS1X15
    me-no-dev/ESPAsyncWebServer
    bblanchon/ArduinoJson
    witnessmenow/UniversalTelegramBot
    knolleary/PubSubClient
    bodmer/TFT_eSPI
    waspinator/AccelStepper

build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DBOARD_HAS_PSRAM

monitor_speed = 115200
upload_speed = 921600
```

---

## 14. Этапы разработки

### Фаза 1: Ядро (2 недели)
- [ ] config.h — пины, константы
- [ ] Драйверы датчиков (DS18B20, BMP280, ADS1115)
- [ ] Драйвер SSR (PWM)
- [ ] Драйвер шагового насоса
- [ ] Базовый WebServer

### Фаза 2: Режимы (2 недели)
- [ ] FSM авто-ректификации
- [ ] Watt-Control
- [ ] Smart Decrement
- [ ] Ручная ректификация
- [ ] Дистилляция

### Фаза 3: Интерфейсы (2 недели)
- [ ] Web UI с анимациями
- [ ] REST API полный
- [ ] Telegram-бот
- [ ] Кнопки + зуммер

### Фаза 4: Расширения (1 неделя)
- [ ] Затирка солода (порт из v1.4.0)
- [ ] Hold режим
- [ ] Сервопривод-фракционник
- [ ] Клапан старт-стоп ШИМ

### Фаза 5: Полировка (1 неделя)
- [ ] OTA обновления
- [ ] Логирование SPIFFS
- [ ] Экспорт CSV
- [ ] Калибровка через UI
- [ ] Тестирование

---

## 15. Конкурентный анализ

| Функция | HelloDistiller | БКУ-07/09 | Pervak 4.2 | **S3** |
|---------|----------------|-----------|------------|--------|
| Фракционник серво | ✓ | — | — | ✓ (5 поз.) |
| Электронный ареометр | — | ЭТС-223 | — | ✓ MPX5010 |
| Watt-Control | Auto+ШИМ | — | — | ✓ |
| Smart Decrement | — | — | ✓ | ✓ |
| Датчик потока воды | — | — | — | ✓ |
| Датчик уровня | ✓ | ✓ | — | ✓ (опция) |
| Web UI | ✓ | — | — | ✓ анимация |
| Telegram | — | — | — | ✓ |
| MQTT / Home Assistant | — | — | — | ✓ Discovery |
| Аутентификация | — | — | — | ✓ Basic Auth |
| Rate Limiting | — | — | — | ✓ |
| OTA | — | — | — | ✓ |
| Логирование | — | — | — | ✓ SPIFFS |
| Затирка солода | — | — | — | ✓ |
| Автокоррекция атм. | — | — | ✓ | ✓ BMP280 |

---

## Приложение A: Схема подключения

```
                    ┌─────────────────────────────────────┐
                    │          ESP32-S3 N16R8             │
                    │                                     │
     DS18B20 ×7 ────┤ GPIO4 (OneWire + 4.7kΩ pullup)     │
                    │                                     │
    BMP280 #1/2 ────┤ GPIO21 (SDA) ──┬── I2C Bus         │
      ADS1115   ────┤ GPIO22 (SCL) ──┘                   │
                    │                                     │
     MPX5010DP ─────┤ ADS1115 A0                         │
                    │                                     │
    SSR-40DA ◄──────┤ GPIO5 (через PC817)                │
                    │                                     │
   TMC2209 STEP ◄───┤ GPIO6                              │
   TMC2209 DIR  ◄───┤ GPIO7                              │
   TMC2209 EN   ◄───┤ GPIO15                             │
                    │                                     │
  Клапан воды  ◄────┤ GPIO16 (MOSFET)                    │
  Клапан голов ◄────┤ GPIO17 (MOSFET)                    │
  Клапан УНО   ◄────┤ GPIO18 (MOSFET)                    │
                    │                                     │
  Серво MG996R ◄────┤ GPIO8 (PWM 50Hz) [опция]           │
  Клапан старт ◄────┤ GPIO9 (ШИМ) [опция]                │
                    │                                     │
     ZMPT101B  ─────┤ GPIO1 (ADC напряжение)             │
      ACS712   ─────┤ GPIO2 (ADC ток)                    │
     YF-S201   ─────┤ GPIO3 (счётчик импульсов)          │
                    │                                     │
      Зуммер   ◄────┤ GPIO38                             │
     Кнопка 1  ─────┤ GPIO0 (Boot)                       │
     Кнопки 2-4 ────┤ GPIO10, 11, 12                     │
                    │                                     │
     TFT 3.5"  ◄────┤ SPI (MOSI, CLK, CS, DC, RST)       │
                    └─────────────────────────────────────┘
```

---

## Приложение B: Формулы

### Электронный ареометр

```
ΔP = P_низ - P_верх  (столб жидкости в попугае)

ρ = ΔP / (g × h)

где:
  g = 9.81 м/с²
  h = высота столба (м)

ABV = f(ρ, T)  — табличная интерполяция с температурной коррекцией
```

### Коррекция температуры кипения

```
T_кип = 100 - (101325 - P_atm) / 3500

где P_atm в Па (от BMP280)
```

### Объём отбора

```
V = обороты × мл_на_оборот

Скорость = ΔV / Δt (мл/час)
```

### Реальная мощность (ACS712 + ZMPT101B)

```
U = (ADC_zmpt - 2048) × k_voltage  (среднеквадратичное)
I = (ADC_acs - 2048) × k_current   (среднеквадратичное)

P_real = U × I × cos(φ)

где:
  k_voltage ≈ 0.17 (калибруется)
  k_current = 0.066 В/А для ACS712-30A
  cos(φ) ≈ 1.0 для ТЭНа (резистивная нагрузка)

Применение:
  - Контроль реальной мощности vs заданной
  - Детекция неисправности ТЭНа
  - Watt-Control с обратной связью
```

---

*Документ создан: 2025-12-02*  
*Автор: Smart-Column S3 Development Team*
