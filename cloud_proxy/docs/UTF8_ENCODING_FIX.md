# Исправление проблем с кодировкой UTF-8

## Проблема
На сайте отображались "кракозябры" (искаженные символы) вместо русских букв из-за неправильной обработки кодировки UTF-8.

## Исправленные файлы

### 1. `cloud_proxy/auth_web.php`
- ✅ Добавлена функция `normalizeToUtf8()` для нормализации строк в UTF-8
- ✅ Улучшена функция `fixEncoding()` для рекурсивной обработки массивов
- ✅ Обновлены функции `login()` и `register()` - нормализуют username в UTF-8
- ✅ В `getCurrentUser()` добавлена проверка наличия username в данных
- ✅ В `saveWebUsers()` добавлена нормализация данных перед сохранением
- ✅ Все `json_encode()` используют `JSON_UNESCAPED_UNICODE`
- ✅ Все заголовки `Content-Type` включают `charset=utf-8`

### 2. `cloud_proxy/login.php`
- ✅ Добавлена нормализация данных из POST запросов в UTF-8
- ✅ HTML страница имеет `<meta charset="UTF-8">`

### 3. `cloud_proxy/web_settings_api.php`
- ✅ Заголовок `Content-Type: application/json; charset=utf-8`
- ✅ Все `json_encode()` используют `JSON_UNESCAPED_UNICODE`

### 4. `cloud_proxy/proxy.php`
- ✅ Все `json_encode()` используют `JSON_UNESCAPED_UNICODE`
- ✅ Все заголовки `Content-Type: application/json` заменены на `Content-Type: application/json; charset=utf-8`
- ✅ Для HTML файлов добавлен `charset=utf-8` в заголовки
- ✅ Для текстовых файлов (html, css, js, json, svg) добавлен `charset=utf-8`
- ✅ Страница 404 имеет правильный `meta charset` и `charset` в заголовке

### 5. `cloud_proxy/esp32_config.php`
- ✅ `json_encode()` использует `JSON_UNESCAPED_UNICODE` при сохранении конфигурации

### 6. `cloud_proxy/fix_encoding.php`
- ✅ Скрипт для исправления кодировки существующего файла `users_web.json`
- ✅ Использует функции нормализации из `auth_web.php`

## HTML файлы
Все HTML файлы в `data/` имеют правильный `<meta charset="UTF-8">`:
- ✅ `data/index.html`
- ✅ `data/manual.html`
- ✅ `data/charts.html`
- ✅ `data/wifi.html`
- ✅ `data/calibration.html`

## Что нужно сделать после загрузки файлов

1. Загрузите все обновленные файлы на сервер

2. Исправьте существующий файл `users_web.json`:
   - Откройте в браузере: `https://smart-column-proxy.spiritcontrol.ru/fix_encoding.php`
   - Скрипт автоматически пересохранит файл в правильной кодировке
   - После исправления удалите файл `fix_encoding.php` с сервера

3. Если проблема сохраняется, пересоздайте пользователя:
   - Зарегистрируйте нового пользователя через форму регистрации
   - Или перезарегистрируйте существующего - данные сохранятся в правильной кодировке

## Проверка

После исправления проверьте:
- ✅ Имя пользователя отображается правильно в header
- ✅ Все сообщения на русском языке отображаются правильно
- ✅ JSON ответы от API правильно кодируются
- ✅ Нет искаженных символов в интерфейсе

## Технические детали

Все изменения обеспечивают:
1. **Нормализацию входных данных** - все данные из POST запросов нормализуются в UTF-8
2. **Правильное сохранение** - все данные сохраняются в UTF-8 с использованием `JSON_UNESCAPED_UNICODE`
3. **Правильное чтение** - при чтении данных проверяется и исправляется кодировка
4. **Правильные заголовки** - все HTTP заголовки указывают `charset=utf-8`
5. **Правильные HTML мета-теги** - все HTML страницы имеют `<meta charset="UTF-8">`
